---
title: "Proteomics analysis pipeline results"
output:
  html_document:
    toc: TRUE
    toc_float: TRUE
    theme: spacelab
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r, warning=FALSE, message=FALSE}
library(dplyr)
library(drake)
library(DT)
library(kableExtra)
library(knitr)
```
  
```{r load targets}
loadd(data_in)
loadd(wilcox_results)
loadd(fold_change_results)
loadd(plot_results)
loadd(random_forest_results)
loadd(proteins_ranked)
loadd(unique_protein_list)
loadd(GO_term_analysis_results)
loadd(pathway_analysis_results)
loadd(disease_analysis_results)
```

## Data

```{r data info display}
names <- c("Number of features", "Number of samples", "Case class", "Control class",
  "Number of samples in case class", "Number of samples in control class")

values <- as.character(c(dim(data_in)[2] - 2, dim(data_in)[1], levels(data_in$Class)[1], 
  levels(data_in$Class)[2],
  nrow(data_in[which(data_in[, 2] == levels(data_in[, 2])[1]), ]),
  nrow(data_in[which(data_in[, 2] == levels(data_in[, 2])[2]), ])))

info <- cbind(names, values)

DT::datatable(info, options = list(dom = 't', ordering = FALSE), colnames = rep("", ncol(info)), )
```

## First analysis {.tabset}

### Wilcoxon rank-sum test

```{r wilcoxon results NA check}

#check for NA values in data frame
wilcoxCounterNA <- sum(is.na(wilcox_results[, 4]))
  
#number of proteins for which p-value was calculated
N <- nrow(wilcox_results) - wilcoxCounterNA

#calculate number of significant proteins
wilcoxResultsSignificant <- wilcox_results %>% 
  filter(Pvalue.adj < 0.05) %>% 
  arrange(Pvalue.adj)

M <- nrow(wilcoxResultsSignificant)

#`r if(wilcoxWarningNA){paste("WARNING:", NAcounter, "NA values detected.", sep = " "}`
```

The wilcoxon test failed for `r wilcoxCounterNA` proteins. 

P-value calculated for **`r N`** proteins. Out of those **`r M`** proteins showed a significant p-value < 0.05. The complete list of significant proteins can be found below.

```{r wilcoxon results table DT}
DT::datatable(wilcoxResultsSignificant, colnames = c("Description", "Gene", "P-value", 
  "Adjusted P-value")) %>% 
  formatRound(c("Pvalue", "Pvalue.adj"), 6)
```

### Fold change 

```{r fold change results NA check}
#check for NA values in data frame
foldChangeCounterNA <- sum(is.na(fold_change_results[, 2]))
```

The fold change calculation failed for `r foldChangeCounterNA` proteins. 

The complete list of the calculated fold change between affected and control samples can be found below.

```{r fold change results table}
# fold_change_results  %>%
# kable(format = "html") %>%
# kable_styling()
DT::datatable(fold_change_results, colnames = c("Description", "Gene", "Fold change")) %>% 
  formatRound("foldChange", 6)
```

### Volcano plot
```{r volcano plot}
plot_results
```

```{r volcano plot marked proteins, eval = FALSE}
indSignificant <- which((results$Pvalue.adj < 0.05 & results$foldChange > 0.25) |
    (results$Pvalue.adj < 0.05 & results$foldChange < -0.25))
resultsSignificant <- results[indSignificant, ]
```

### Info

**Wilcoxon rank-sum test**

The Wilcoxon rank-sum test is a non-parametiric statistical test that can be used to find significant differences between two unpaired groups that are not normally distributed. The observations of the two groups are combined and ordered by their value. A rank is assigned to each from low to high and the mean rank of both groups is then compared. A bigger difference between the mean ranks of the two groups, will produce a smaller and therefore more significant P-value^1^. The P-value is adjusted for multiple testing using the FDR method. 

In this analysis the mean ranks of the two classes `r levels(data_in[, 2])[1]` and `r levels(data_in[, 2])[2]`are compared.

**Fold change**

The calculation of the fold change for every feature, i.e. protein, allows to compare the difference in gene expression of a case group compared to a control group used as a baseline. It allows the identification of differentially-expressed genes between the two conditions^2^. As the input data is already expected to be log2-transformed, the fold change is simply the difference between the means of the control group, `r levels(data_in[, 2])[2]`, and the case group, `r levels(data_in[, 2])[1]`. 

$$FC_i = mean(X_i) - mean(Y_i)$$

A negative value for the fold change of a gene signals a downregulation of the expression, a positive fold change value signals upregulation.

**Volcano plot**

The volcano plot is a visulaization method to display statistical significance of a difference versus the magnitude of change. This is achieved by plotting the log2 fold change on the x-axis and the negative log10 of the adjusted P-value on the y-axis for every protein in the data set^3^. The dotted lines mark a significant adjusted P-value (horizontally) and a gene expression in the case group increased or decreased by 0.2.

## Random Forest Classification {.tabset}

### Model accuracy

```{r random forest accuracy}
testError <- vector()

for (i in 1:length(random_forest_results)) {
    #subset one random forest object
    fit.RF <- random_forest_results[[i]]
    #extract feature importance ranking and append to results vector
    testError <- append(testError, fit.RF$test$err.rate[fit.RF$ntree])
}

accuracy <- sapply(testError, FUN = function(x) (1 - x)*100)
```

The classification models produced an average accuracy of **`r round(mean(accuracy), 2)`** with a standard deviation of **`r round(sd(accuracy), 2)`**. The distribution of the individual model accuracies is shown in the following boxplot.

```{r random forest accuracy plot}
ggplot(as.data.frame(accuracy), aes(x="", y = accuracy)) + 
  geom_boxplot(colour = "black", fill = "dodgerblue4") +
  labs(x = "", y = "accuracy", title = "Classification accuracy of Random Forest models")
```

### Protein ranking

```{r proteins ranked table}
# proteins_ranked  %>%
# kable(format = "html") %>%
# kable_styling()

DT::datatable(proteins_ranked, rownames = FALSE) %>% 
  formatRound("Importance", 6)
```


### Protein set selection

`r nrow(unique_protein_list)` were selected for further analysis.

```{r proteins selected importance table}
# unique_protein_list  %>%
# kable(format = "html") %>%
# kable_styling()

DT::datatable(unique_protein_list, rownames = FALSE)
```

### Highest ranking proteins

```{r proteins selected importance plot}
ranking_plot <- proteins_ranked[1:10, 2:3]

ranking_plot$Gene <- factor(ranking_plot$Gene,
                        levels=ranking_plot$Gene)

ggplot(ranking_plot, aes(x = ranking_plot[, 1], y = ranking_plot[, 2])) +
  geom_bar(aes(), stat="identity", colour = "black", fill = "dodgerblue4") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    labs(x = "Genes", y = "Importance", title = 
      "Genes with highest average importance across all Random Forests")
```

### Info 

**Random Forest**

Random forest is a supervised machine learning method that can be used for classification problems. The aim of the model in this pipeline is to correctly predict for an observation which class it belongs to based on the protein measurements of that observation.

The method works by segmenting the feature space into simpler regions that allow the assignment of an observation to a class. The rules for splitting the feature space can be summarized in so-called decision trees. To build such a decision tree, the model searches for the feature that is best suitable to split the observations in a way that separates the two classes in the data set the best. After a first split, two non-overlapping subregions of the feature space exist and the model searches for the next feature to further separate the regions according to their classes. This step is repeated again and again to grow the tree and to segment the feature space more and more into regions of higher class purity^4^.

Random forest use two strategies to improve the accuracy of this tree-based classifiaction. As the name suggests, the class prediction for an observation is based on many decision trees instead of just one. The consensus of all trees is the class chosen by the model. Moreover, before each tree for the model is built a random sampling of the features is performed. As a result, every tree can only use a small subset of the available features which ensures that the trees in a random forest are different and uncorrelated to each other^4^. 

In the pipeline 20 random forest models were built each containing 6000 trees. 

For more information on the algorithm used, see the randomForest R package documentation: https://www.rdocumentation.org/packages/randomForest/versions/4.6-14/topics/randomForest.

**Protein ranking**

Random forest allows to rank all variables used based on their importance for the classification model. The ranking is based on the mean decrease in Gini index. The Gini index is considered a measure of node purity and is defined as

$$G = \sum_{k=1}^K p_{mk}(1-p_{mk})$$

with $p_{mk}$ representing the proportion of observations in the m^th^ region that are from the k^th^ class^4^.

The decrease in Gini index measures the decrease in impurity that a feature facilitates as it is used in a split of the feature space and therefore measures the impact of this variable on the classification. The mean decrease in Gini index is the average of the impurity reductions over all trees in which the variable was used for classification. The higher the decrease in Gini index, the higher the importanceof that variable in the model^5^.

The rankign of the proteins is based on all 20 random forest models built by averaging the mean decrease in Ginin index of all forests.

**Protein set selection**

The selection of proteins that are analysed further depends on their mean Gini index relative to the feature with the highest importance. Every variable with an importance measure of at least one third of the highest ranking protein is included. If less than 20 proteins were selected by this measurement, the list is expanded using the results of the Wilcoxon test. Duplicates of the same protein are removed at this stage.


## Protein set analysis {.tabset}

### Gene ontology term analysis
  
```{r GO term analysis}
# as.data.frame(GO_term_analysis_results) %>%
#   kable(format = "html") %>%
#   kable_styling()

DT::datatable(as.data.frame(GO_term_analysis_results), rownames = FALSE, 
  colnames = c("ID", "Description",   "Gene Ratio", "BG Ratio", "P-value", "Adjusted P-value", 
  "Q-value", "Gene ID")) %>% 
  formatRound(c("pvalue", "p.adjust", "qvalue"), 6)
```


### Pathway enrichment analysis
  
```{r pathway enrichment analysis}
# data.frame(pathway_analysis_results) %>%
#   kable(format = "html") %>%
#   kable_styling()

DT::datatable(data.frame(pathway_analysis_results), rownames = FALSE, 
  colnames = c("ID", "Description", "Gene Ratio", "BG Ratio", "P-value", "Adjusted P-value", 
  "Q-value", "Gene ID")) %>% 
  formatRound(c("pvalue", "p.adjust", "qvalue"), 6)
```


### Disease ontology analysis 
  
```{r disease analysis}
# data.frame(disease_analysis_results) %>%
#   kable(format = "html") %>%
#   kable_styling()

DT::datatable(data.frame(disease_analysis_results), rownames = FALSE, 
  colnames = c("ID", "Description", "Gene Ratio", "BG Ratio", "P-value", "Adjusted P-value", 
  "Q-value", "Gene ID")) %>% 
  formatRound(c("pvalue", "p.adjust", "qvalue"), 6)
```

### Gene set enrichment analysis

```{r}
DT::datatable(data.frame(disease_analysis_results), rownames = FALSE, 
  colnames = c("ID", "Description", "Gene Ratio", "BG Ratio", "P-value", "Adjusted P-value", 
  "Q-value", "Gene ID")) %>% 
  formatRound(c("pvalue", "p.adjust", "qvalue"), 6)
```

### Info

## References

1 McDonald JH. 2014. Handbook of Biological Statistics (3rd ed.), pp.157-164. Sparky House
Publishing, Baltimore, Maryland.

2 Witten DM, Tibshirani R. 2007. A comparison of fold-change and the t-statistic
for microarray data analysis. Stanford University. 1-13.

3 Doyle M. 2019 Visualization of RNA-Seq results with Volcano Plot (Galaxy Training Materials). /training-material/topics/transcriptomics/tutorials/rna-seq-viz-with-volcanoplot/tutorial.html Online; accessed Fri Apr 17 2020

4 James G, Witten D, Hastie T, Tibshirani R. 2013. An Introduction to Statistical Learning: with
Applications in R (8^th^ ed.). Springer Science+Business Media, New York.

5 Archer KJ, Kimes RV. 2008. Empirical characterization of random forest variable importance measures. Computational Statistics & Data Analysis, 52(4), 2249–2260. doi:10.1016/j.csda.2007.08.015.

6

7

8
